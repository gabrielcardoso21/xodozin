FROM node:20-alpine

WORKDIR /app

# Instalar apenas dependências de runtime necessárias
RUN apk add --no-cache python3 make g++

# Copiar arquivos de dependências primeiro (para cache do Docker)
COPY package*.json ./

# Instalar dependências e limpar cache
RUN npm install --legacy-peer-deps && \
    npm cache clean --force && \
    rm -rf /tmp/* /var/cache/apk/*

# Copiar apenas arquivos necessários
COPY src/ ./src/
COPY medusa-config.js ./
COPY tsconfig.json ./
COPY start.sh ./
RUN chmod +x start.sh

# Limpar arquivos desnecessários
RUN rm -rf node_modules/.cache && \
    find node_modules -name "*.md" -delete && \
    find node_modules -name "*.map" -delete && \
    find node_modules -name "test" -type d -exec rm -rf {} + 2>/dev/null || true && \
    find node_modules -name "tests" -type d -exec rm -rf {} + 2>/dev/null || true && \
    find node_modules -name "__tests__" -type d -exec rm -rf {} + 2>/dev/null || true

# Expor porta
EXPOSE 9000

# Comando para desenvolvimento
CMD ["sh", "start.sh"]

